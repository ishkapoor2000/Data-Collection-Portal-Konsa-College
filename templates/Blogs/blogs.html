<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Konsa College - Blogger's Portal</title>
    <meta name="robots" content="noindex, follow" />
    <meta name="description" content="Martup is Multipurpose eCommerce HTML Template, that's perfect for any kind of eCommerce websites such as fashion, furniture and many more.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ::::::::::::::Favicon icon::::::::::::::-->
    <link rel="icon" href="{{ url_for('static', filename='images/KonsaCollege_Logo.svg') }}" type="image/any-icon">

    <!-- ::::::::::::::All CSS Files here :::::::::::::: -->
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">

<!--     <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap');
        /* Image uploader CSS Start */
        
         :root {
            --base_color: #ffd900;
            --top_color: #e9f0ff;
            --secondary_color: #404040;
            --bor_rad: 5px;
        }
        
        .wrapper {
            width: 430px;
            padding: 30px;
            border-radius: var(--bor_rad);
        }
        
        .wrapper .devo {
            border: 2px dashed var(--base_color);
            height: 167px;
            cursor: pointer;
            border-radius: var(--bor_rad);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            margin: 30px 0px;
        }
        
        .devo :where(i,
        p) {
            color: black;
            text-align: center;
        }
        
        .devo i {
            font-size: 3.125rem;
        }
        
        .wrapper::-webkit-scrollbar {
            width: 0em;
        }
        /* Image uploader CSS End */
        /* Blogger Profile Start */
        
        .search-event::after {
            content: none;
            border-radius: 5px solid red;
        }
        
        .widget-social-icon a,
        .author-blog-details,
        .breadcrumb-wrapper--style-4.breadcrumb-bg {
            background-color: #ffd90090;
            border: none;
        }
        
        .author-blog-details .content,
        .breadcrumb-wrapper--style-4 .breadcrumb-nav *,
        .breadcrumb-wrapper--style-4 .content,
        .breadcrumb-wrapper--style-4 .title {
            color: #111 !important;
        }
        
        a,
        button,
        input,
        textarea {
            border: none;
            outline: none !important;
            background: none;
            -webkit-box-shadow: none;
            box-shadow: none;
            padding: 0;
        }
        
        input,
        textarea {
            width: 100%;
        }
    </style>

</head>

<body>
	<nav class="navbar navbar-light bg-dark">
		<div class="container">
			<a class="navbar-brand" href="https://konsacollege.com">
				<img src="{{ url_for('static', filename='images/KonsaCollege_Logo.svg') }}" height="30" alt="Konsa College Logo" loading="lazy" />
			</a>
		</div>
	</nav>
    <div class="row">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-body">
                    <form class="form" action="/blogs" method="POST">
                        <div class="mb-3 row">
                            <label for="author" class="col-md-2 col-form-label">Author</label>
                            <div class="col-md-10">
                                <input required class="form-control" type="text" placeholder="Writer..." name="author" id="author" spellcheck="false" data-ms-editor="true">
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="category_id" class="col-md-2 col-form-label">Category ID</label>
                            <div class="col-md-10">
                                <select required class="form-select col-12" name="category_id" id="category_id">
									<option selected="">Choose Category...</option>
									<option value=1>College Stories</option>
									<option value=2>JEE Colleges</option>
									<option value=3>AI Tech.</option>
								</select>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="header_image" class="col-md-2 col-form-label">Choose Header Image</label>
							<input required class="form-control" type="file" id="header_image_file">
							<img width="500px" height="auto" src="" id="header_image_preview">
							<input type="text" required name="header_image" id="header_image" value="" hidden>
                        </div>

						<div class="mb-3 row">
	                        <label for="title" hidden>Blog Title</label>
	                        <h1><input type="text" required name="title" id="title" placeholder="Write title here..."></h1>
						</div>

                        <div class="mb-3 row">
							<label for="subheading" hidden>Write Sub-heading</label>
                        	<h3><input type="text" required name="subheading" id="subheading" placeholder="Write sub-heading here..."></h3>
						</div>

                        <div class="mb-3 row">
							<input name="content" id="content" type="text" hidden>
                            <div class="ms-1 rounded shadow-lg bg-body" id="editorjs"></div>
                        </div>

                        <div class="text-center">
                            <button type="submit" id="draft-button" class="me-4 btn btn-primary">Save as Draft</button>
							<br>
							<small>Clicking on preview button multiple times causes error & deletion of critical data from your article. Be careful with that. Save your progress somewhere else.</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
	<div class="container">
		<div class="text-center">
			<button type="text" id="preview-button" class="me-4 btn btn-dark">Preview Raw</button>
		</div>
		<div style="overflow: scroll;" id="preview-article"></div>
		<div style="overflow: scroll;" class="accordion mt-3" id="accordion_mode_of_admission">
		   <div class="accordion-item">
			 <h2 class="accordion-header" id="heading_mode_of_admission">
			   <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_mode_of_admission" aria-expanded="true" aria-controls="collapse_mode_of_admission">
				 View Raw JSON Content
			   </button>
			 </h2>
			 <div id="collapse_mode_of_admission" class="accordion-collapse collapse" aria-labelledby="heading_mode_of_admission" data-bs-parent="#accordion_mode_of_admission">
			   <div class="accordion-body">
				<div id="preview-raw-data"></div>
			   </div>
			 </div>
		   </div>
		 </div>
	</div>

    <!-- Main Editor #2 Start -->
	<div class="container m-3 p-2">
		{% set category_ids = ['', 'College Stories', 'JEE Colleges', 'AI Tech.'] %}
		{% set approvedStatusList = ['Un-Approved', 'Approved'] %}
		<div class="row">
			{% for blog in all_blogs %}
			<div class="col-lg-4 col-md-6">
				<div class="card">
					  <img src="{{blog.header_image}}" class="card-img-top" alt="Header Image" style="height: 150px;object-fit: contain;">
					  <div class="card-body">
						<p class="card-text">{{blog.author}}</p>
						<h5 class="card-title fs-5">{{blog.title}}</h5>
						<p class="card-text">{{blog.subheading}}</p>
					  </div>
					  <ul class="list-group list-group-flush">
						<li class="list-group-item">{{blog.created_at}}</li>
						<li class="list-group-item">{{category_ids[blog.category_id]}}</li>
						<li class="list-group-item">{{approvedStatusList[blog.approvedStatus]}}</li>
					  </ul>
					  <div class="card-body button-group d-flex align-items-stretch">
						<a href="/update_blog/{{blog.sno}}" class="btn btn-light-secondary text-secondary" title="Update"><i class="fill-white bi bi-pencil"></i></a>
						<a href="" class="btn btn-light-secondary text-secondary" title="Preview"><i class="fill-white bi bi-eye-fill"></i></a>
						<div class="ms-auto">
							<a href="/delete_user_blog/{{blog.sno}}" class="btn btn-light-secondary text-secondary flex-column flex-sm-row" title="Delete"><i class="fill-white bi bi-trash"></i></a>
						</div>
					  </div>
				</div>
			</div>
			{% endfor %}
		</div>
	</div>

    <!-- Main Editor #2 End -->


    <!-- EditorJs API CDN Scripts Start -->

    <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-image-editorjs@latest"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.js" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

	<script>
		const cloudinaryUrl = 'https://api.cloudinary.com/v1_1/doyci5m01/image/upload' // The URL of the Cloudinary API to upload images.
		const cloudinaryUploadPreset = 'caoeu9ot' // Replace with your upload preset
		const folder = 'konsa-college-blogs-assets'// The folder name in the Cloudinary account to upload images to.

		/**
		* Uploads an image to Cloudinary.
		* @param {File} file - The image file to upload.
		* @param {string} folder - The folder name to upload the image to.
		* @param {string} name - The name of the image.
		* @param {string} cloudinaryUrl - The Cloudinary API URL.
		* @param {string} cloudinaryUploadPreset - The Cloudinary upload preset name.
		// @returns {Promise<Response>} The response from the Cloudinary API.
		* @returns {string} The URL from response of the Cloudinary API.
		*/

		async function uploadOnCloud (file, folder, name, cloudinaryUrl, cloudinaryUploadPreset) {
			try {
				// Upload the image to Cloudinary
				const formData = new FormData();
				formData.append("file", file);
				formData.append("public_id", `${folder}/${name}`); // Add the folder to the public ID
				formData.append('upload_preset', cloudinaryUploadPreset);
				const cloudinaryResponse = await fetch( cloudinaryUrl, {
						method: "POST",
						body: formData
					}
				)
				if (cloudinaryResponse.ok) {
					const cloudinaryData = await cloudinaryResponse.json()
					return cloudinaryData.secure_url
				} else {
					throw new Error('Failed to upload image to Cloudinary');
				}
			} catch (error) {
				console.error(error);
				throw new Error('Failed to upload image to Cloudinary');
			}
		}

        // Get the Editor.js instance
		const editor = new EditorJS({
		    // Specify the Simple Image Tool with an uploader
		    tools: {
				header: Header,
				list: List,
		        image: {
		            class: SimpleImage,
		            config: {
		                uploader: {
		                    uploadByFile(file) {
		                        return new Promise((resolve) => {
		                            const reader = new FileReader();
		                            reader.readAsDataURL(file);
		                            reader.onload = () => {
		                                resolve({
		                                    success: 1,
		                                    file: {
		                                        url: reader.result,
		                                    },
		                                });
		                            };
		                        });
		                    },
		                },
		            },
		        },
		    },
		    // Other Editor.js configuration options
		    // ...
		});

		$('#draft-button').hide()

		$("#preview-button").click(async function() {
            try {
                // Save the editor data
                const eitorJsonData = await editor.save();

                // Find all images in the saved data
                const images = eitorJsonData.blocks
                    .filter((block) => block.type === "image")
                    .map((block) => block.data.url);
                // Find all captions in the saved data
                const captions = eitorJsonData.blocks
                    .filter((block) => block.type === "image")
                    .map((block) => block.data.caption);

				if (images.length > 0) {
	                // Upload each image to Cloudinary and replace the original URL with the Cloudinary URL
	                for (const [index, imageUrl] of images.entries()) {
	                    try {
	                        const response = await fetch(imageUrl);
	                        const blob = await response.blob();
	
	                        const cloudinaryData = await uploadOnCloud(blob, folder, captions[index], cloudinaryUrl, cloudinaryUploadPreset)
	
	                        // Replace the original image URL with the Cloudinary URL
	                        eitorJsonData.blocks.forEach((block) => {
	                            if (block.type === "image" && block.data.url === imageUrl) {
	                                block.data.url = cloudinaryData
	                            }
	                        })

	                    } catch (error) {
							alert("Error. Check Console.")
	                        console.error(error)
	                    }
					}
                }

                console.log("Article data: ", eitorJsonData);

                // Preview the article
                preview(eitorJsonData);

                // Set the form value
                $("#content").val(JSON.stringify(eitorJsonData, null, 2));

                // Show the draft button
                $("#draft-button").show();
            } catch (error) {
                console.error(error)
    			alert('Error previewing article. Saving failed. Check Console.')
            }
        });
		

		const preview = (data) => {
			$('#preview-raw-data').html('')
			$('#preview-article').html('')
			data['blocks'].forEach((item) => {
				switch (item.type) {
					case 'header':
						$('#preview-article').append(`<h${item.data.level}>${item.data.text}</h${item.data.level}>`)
						break
					case 'list':
						var listStyle = (item.data.items === 'unordered') ? 'ul' : 'ol'
						$('#preview-article').append(`<${listStyle}></${listStyle}>`)
						for (const i of item.data.items) {
							$(`#preview-article ${listStyle}`).append(`<li>${i}</li>`)
						}
						break
					case 'paragraph':
						$('#preview-article').append(`<p>${item.data.text}</p>`)
						break
					case 'image':
						$('#preview-article').append(`<img src="${item.data.url}">`)
						break
					default:
						break
				}
			})
			$('#preview-raw-data').append(`${JSON.stringify(data, null, 2)}`)
		}

        $("#header_image_file").on('change', async function() {
			console.log(`Header file: ${this.files[0].name} uploaded to Cloudinary. Ready to save in DB.`)
			try {
				const cloudinaryData = await uploadOnCloud(this.files[0], folder, this.files[0].name, cloudinaryUrl, cloudinaryUploadPreset)
				// const cloudinaryData = await cloudinaryResponse.json().secure_url
				$("#header_image_preview").attr('src', cloudinaryData)
				$("#header_image").val(cloudinaryData)
			} catch (error) {
				alert("Error. Check Console.")
                console.error(error)
			}
        });

    </script>
    <!-- Upload Cover Image Script End -->

</body>

</html>